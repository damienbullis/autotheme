name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger workflow for semantic version tags like v1.2.3
  workflow_dispatch: # Allow manual triggering of workflow
      

jobs:
  release:
    runs-on: ubuntu-latest
    permissions: 
      contents: write
      packages: write


    steps:
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '^1.21'

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ensure tags are fetched

      - name: Set VERSION environment variable
        # id: get_version
        run: echo "VERSION=$(git describe --tags --abbrev=0)" >> $GITHUB_ENV

      - name: Install git-chglog
        run: |
          curl -sL https://github.com/git-chglog/git-chglog/releases/download/v0.15.4/git-chglog_0.15.4_linux_amd64.tar.gz | tar xz && \
          sudo mv git-chglog /usr/local/bin/git-chglog

      - name: Ensure tags exist
        run: |
          if [ -z "$(git tag)" ]; then
            echo "No Git tags found. Creating a tag for changelog generation."
            exit 1
          fi

      - name: Generate Changelog
        run: git-chglog -o CHANGELOG.md

      - name: Commit Changelog
        run: |
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add CHANGELOG.md
          git commit -m "Update changelog for ${{ github.ref }}"
          git push

      - name: Install GoReleaser
        run: |
          curl -sL https://git.io/goreleaser | bash

      - name: Run GoReleaser
        run: goreleaser release --rm-dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ env.VERSION }}